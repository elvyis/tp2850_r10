C51 COMPILER V9.60.7.0   APP340                                                            12/22/2023 18:00:43 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE APP340
OBJECT MODULE PLACED IN .\obj\app340.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE src\MDIN3xx\app340.c LARGE OPTIMIZE(9,SIZE) BROWSE DEBUG OBJECTEXTEND PR
                    -INT(.\lst\app340.lst) TABS(2) OBJECT(.\obj\app340.obj)

line level    source

   1          //--------------------------------------------------------------------------------------------------------
             ---------------
   2          // (C) Copyright 2010  Macro Image Technology Co., LTd. , All rights reserved
   3          // 
   4          // This source code is the property of Macro Image Technology and is provided
   5          // pursuant to a Software License Agreement. This code's reuse and distribution
   6          // without Macro Image Technology's permission is strictly limited by the confidential
   7          // information provisions of the Software License Agreement.
   8          //--------------------------------------------------------------------------------------------------------
             ----------------
   9          //
  10          // File Name      : APP340.C
  11          // Description    :
  12          // Ref. Docment   : 
  13          // Revision History   :
  14          
  15          //--------------------------------------------------------------------------------------------------------
             -------------------
  16          // You must make drive functions for I2C read & I2C write.
  17          //--------------------------------------------------------------------------------------------------------
             -------------------
  18          // static BYTE MDINI2C_Write(BYTE nID, WORD rAddr, PBYTE pBuff, WORD bytes)
  19          // static BYTE MDINI2C_Read(BYTE nID, WORD rAddr, PBYTE pBuff, WORD bytes)
  20          
  21          //--------------------------------------------------------------------------------------------------------
             -------------------
  22          // You must make drive functions for delay (usec and msec).
  23          //--------------------------------------------------------------------------------------------------------
             -------------------
  24          // MDIN_ERROR_t MDINDLY_10uSec(WORD delay) -- 10usec unit
  25          // MDIN_ERROR_t MDINDLY_mSec(WORD delay) -- 1msec unit
  26          
  27          //--------------------------------------------------------------------------------------------------------
             -------------------
  28          // You must make drive functions for debug (ex. printf).
  29          //--------------------------------------------------------------------------------------------------------
             -------------------
  30          // void UARTprintf(const char *pcString, ...)
  31          
  32          // ----------------------------------------------------------------------
  33          // Include files
  34          // ----------------------------------------------------------------------
  35          #include  <string.h>
  36          #ifndef   __MDIN3xx_H__
  37          #include   "mdin3xx.h"
  38          #endif
  39          #include  "..\inc\tp2825.h" // 
  40          // ----------------------------------------------------------------------
  41          // Static Global Data section variables
  42          // ----------------------------------------------------------------------
  43          static MDIN_VIDEO_INFO    stVideo;
  44          static MDIN_INTER_WINDOW  stInterWND;
  45          
  46          // ----------------------------------------------------------------------
C51 COMPILER V9.60.7.0   APP340                                                            12/22/2023 18:00:43 PAGE 2   

  47          // External Variable 
  48          // ----------------------------------------------------------------------
  49          extern xdata BYTE ManVidRes;
  50          extern bit MDIN_debug;
  51          extern bit half_scaler;
  52          extern bit BT1120_out;
  53          extern bit en_960P;
  54          
  55          // ----------------------------------------------------------------------
  56          // Static Prototype Functions
  57          // ----------------------------------------------------------------------
  58          
  59          // ----------------------------------------------------------------------
  60          // Static functions
  61          // ----------------------------------------------------------------------
  62          
  63          // ----------------------------------------------------------------------
  64          // Exported functions
  65          // ----------------------------------------------------------------------
  66          
  67          //--------------------------------------------------------------------------------------------------------
             -------------------
  68           void CreateMDIN340VideoInstance(void)
  69          {
  70   1        WORD nID = 0;
  71   1      
  72   1        MDIN3xx_GetChipID(&nID);  // get chip-id
  73   1        MDIN3xx_HardReset();
  74   1        MDIN3xx_SoftReset();
  75   1        MDIN3xx_EnableMainDisplay(OFF);   // set main display off
  76   1        MDIN3xx_SetMemoryConfig();      // initialize DDR memory
  77   1      
  78   1        MDIN3xx_SetVCLKPLLSource(MDIN_PLL_SOURCE_XTAL); // set PLL source
  79   1        MDIN3xx_EnableClockDrive(MDIN_CLK_DRV_ALL, ON);
  80   1      
  81   1        MDIN3xx_SetInDataMapMode(MDIN_IN_DATA24_MAP3);  // set in-data map
  82   1      
  83   1        // setup enhancement
  84   1        MDIN3xx_SetFrontNRFilterCoef(NULL);   // set default frontNR filter coef
  85   1        MDINAUX_SetFrontNRFilterCoef(NULL);   // set default frontNR filter coef
  86   1        MDIN3xx_SetPeakingFilterCoef(NULL);   // set default peaking filter coef
  87   1        MDIN3xx_SetColorEnFilterCoef(NULL);   // set default color enhancer coef
  88   1        MDIN3xx_SetBlockNRFilterCoef(NULL);   // set default blockNR filter coef
  89   1        MDIN3xx_SetMosquitFilterCoef(NULL);   // set default mosquit filter coef
  90   1        MDIN3xx_SetColorTonFilterCoef(NULL);    // set default colorton filter coef
  91   1      
  92   1        MDIN3xx_EnableLTI(OFF);         // set LTI off
  93   1        MDIN3xx_EnableCTI(OFF);         // set CTI off
  94   1        MDIN3xx_SetPeakingFilterLevel(0);   // set peaking gain
  95   1        MDIN3xx_EnablePeakingFilter(ON);    // set peaking on
  96   1        MDIN3xx_EnableColorEnFilter(ON);    // set color enhancement on
  97   1      
  98   1        //MDIN3xx_EnableFrontNRFilter(OFF);   // set frontNR off
  99   1        MDIN3xx_EnableFrontNRFilter(ON);    // set frontNR on
 100   1        MDIN3xx_EnableBWExtension(OFF);     // set B/W extension off
 101   1      
 102   1        MDIN3xx_SetIPCBlock();    // initialize IPC block (3DNR gain is 34)
 103   1      
 104   1        memset((PBYTE)&stVideo, 0, sizeof(MDIN_VIDEO_INFO));
 105   1      
 106   1        MDIN3xx_SetMFCHYFilterCoef(&stVideo, NULL); // set default MFC filters
 107   1        MDIN3xx_SetMFCHCFilterCoef(&stVideo, NULL);
C51 COMPILER V9.60.7.0   APP340                                                            12/22/2023 18:00:43 PAGE 3   

 108   1        MDIN3xx_SetMFCVYFilterCoef(&stVideo, NULL);
 109   1        MDIN3xx_SetMFCVCFilterCoef(&stVideo, NULL);
 110   1      
 111   1        // set aux display OFF
 112   1        stVideo.dspFLAG = MDIN_AUX_DISPLAY_OFF | MDIN_AUX_FREEZE_ON;
 113   1      
 114   1        // set video path (main/aux/dac/enc)
 115   1        stVideo.srcPATH = PATH_MAIN_A_AUX_B;  // set main is A, aux is B
 116   1        stVideo.dacPATH = DAC_PATH_MAIN_OUT;  // set main only
 117   1      
 118   1        // if you need to front format conversion then set size.
 119   1      //  stVideo.ffcH_m  = 1440;
 120   1      
 121   1        // define video format of PORTA-INPUT
 122   1      
 123   1      switch(ManVidRes)
 124   1        {
 125   2          case TP2802_WXGA:
 126   2          stVideo.stSRC_a.frmt = VIDSRC_1280x720p60;
 127   2          stVideo.stOUT_m.frmt = VIDOUT_1280x720p60;
 128   2          break;
 129   2          
 130   2          case TP2802_QHD25:
 131   2          case TP2802_1080P50:  
 132   2                if(!BT1120_out)
 133   2                {
 134   3                  half_scaler=1;
 135   3                }
 136   2          case TP2802_1080P25:
 137   2          case TP2802_1080P24:
 138   2          case TP2802_1080P27:
 139   2          case TP2802_8M12:
 140   2          case TP2802_5M12:
 141   2          case TP2802_1080P_X3C:  
 142   2          stVideo.stSRC_a.frmt = VIDSRC_1920x1080p50;
 143   2          stVideo.stOUT_m.frmt = VIDOUT_1920x1080p50;
 144   2          break;  
 145   2      
 146   2          //case TP2802_1080P25:
 147   2          case TP2802_1080P30:  
 148   2          case TP2802_960P25:   
 149   2                if(en_960P)
 150   2                {
 151   3                  stVideo.stSRC_a.frmt = VIDSRC_1280x960p30;
 152   3                  stVideo.stOUT_m.frmt = VIDOUT_1280x960p60;            
 153   3                }
 154   2                else
 155   2                {
 156   3                  stVideo.stSRC_a.frmt = VIDSRC_1920x1080p60;
 157   3                  stVideo.stOUT_m.frmt = VIDOUT_1920x1080p60;                   
 158   3                }
 159   2                break;
 160   2          
 161   2          case TP2802_QHD30:
 162   2          case TP2802_QHD275:
 163   2                if(!BT1120_out)
 164   2                {
 165   3                  half_scaler=1;
 166   3                }     
 167   2            
 168   2          stVideo.stSRC_a.frmt = VIDSRC_1280x960p30;
 169   2          stVideo.stOUT_m.frmt = VIDOUT_1920x1080p60;
C51 COMPILER V9.60.7.0   APP340                                                            12/22/2023 18:00:43 PAGE 4   

 170   2          break;
 171   2          
 172   2          case TP2802_1080P60:
 173   2          case TP2802_5M20:   
 174   2                if(!BT1120_out)
 175   2                {
 176   3                  half_scaler=1;
 177   3                }     
 178   2            
 179   2          case TP2802_1080P15:
 180   2          case TP2802_8M15:
 181   2          stVideo.stSRC_a.frmt = VIDSRC_1920x1080p60;
 182   2          stVideo.stOUT_m.frmt = VIDOUT_1920x1080p60;
 183   2          break;    
 184   2      
 185   2          case TP2802_720P30:
 186   2          case TP2802_720P60:
 187   2          case TP2802_720P30V2:
 188   2          case TP2802_720P30HDR:
 189   2          case TP2802_720P864M: 
 190   2          stVideo.stSRC_a.frmt = VIDSRC_1280x720p60;
 191   2          stVideo.stOUT_m.frmt = VIDOUT_1280x720p60;
 192   2          break;
 193   2          
 194   2          case TP2802_720P25:
 195   2          case TP2802_720P50:
 196   2          case TP2802_720P25V2:
 197   2          case TP2802_720P25HDR:
 198   2          stVideo.stSRC_a.frmt = VIDSRC_1280x720p50;
 199   2          stVideo.stOUT_m.frmt = VIDOUT_1280x720p50;
 200   2          break;
 201   2        
 202   2          case TP2802_NTSC:
 203   2          stVideo.stSRC_a.frmt = VIDSRC_720x480i60;
 204   2          stVideo.stOUT_m.frmt = VIDOUT_1280x720p60;
 205   2          break;
 206   2          case TP2802_PAL:
 207   2          stVideo.stSRC_a.frmt = VIDSRC_720x576i50;
 208   2          stVideo.stOUT_m.frmt = VIDOUT_1280x720p50;
 209   2          break;
 210   2      
 211   2          case TP2802_1280x320P60:
 212   2          stVideo.stSRC_a.frmt = VIDSRC_1280x320p60;
 213   2          stVideo.stOUT_m.frmt = VIDOUT_1280x720p60;
 214   2          break;    
 215   2      
 216   2          case TP2802_480P20:
 217   2          stVideo.stSRC_a.frmt = VIDSRC_1024x518p60;
 218   2          stVideo.stOUT_m.frmt = VIDOUT_1280x720p60;
 219   2          break;        
 220   2        }
 221   1      
 222   1          //stVideo.stSRC_a.frmt = VIDSRC_1920x1080p60;
 223   1          //stVideo.stOUT_m.frmt = VIDOUT_1920x1080p60;
 224   1        if(BT1120_out)
 225   1        {
 226   2          stVideo.stSRC_a.mode = MDIN_SRC_EMB422_8;
 227   2          //stVideo.stSRC_a.mode = MDIN_SRC_SEP422_8;
 228   2        }
 229   1        else
 230   1        { 
 231   2          stVideo.stSRC_a.mode = MDIN_SRC_MUX656_8;
C51 COMPILER V9.60.7.0   APP340                                                            12/22/2023 18:00:43 PAGE 5   

 232   2          //stVideo.stSRC_a.mode = MDIN_SRC_SEP656_8;
 233   2        }
 234   1        stVideo.stSRC_a.fine = MDIN_FIELDID_INPUT | MDIN_LOW_IS_TOPFLD;
 235   1        stVideo.stSRC_a.offH = 0;
 236   1        stVideo.stSRC_a.offV = 0;
 237   1      
 238   1        // define video format of MAIN-OUTPUT
 239   1      
 240   1        stVideo.stOUT_m.mode = MDIN_OUT_RGB444_8;
 241   1        stVideo.stOUT_m.fine = MDIN_SYNC_FREERUN; // set main outsync free-run
 242   1      
 243   1        stVideo.stOUT_m.brightness = 128;     // set main picture factor
 244   1        stVideo.stOUT_m.contrast = 128;
 245   1        stVideo.stOUT_m.saturation = 128;
 246   1        stVideo.stOUT_m.hue = 128;
 247   1      
 248   1      #if RGB_GAIN_OFFSET_TUNE == 1
                stVideo.stOUT_m.r_gain = 128;       // set main gain/offset
                stVideo.stOUT_m.g_gain = 128;
                stVideo.stOUT_m.b_gain = 128;
                stVideo.stOUT_m.r_offset = 128;
                stVideo.stOUT_m.g_offset = 128;
                stVideo.stOUT_m.b_offset = 128;
              #endif
 256   1      
 257   1        // define video format of IPC-block
 258   1        stVideo.stIPC_m.mode = MDIN_DEINT_ADAPTIVE;
 259   1        stVideo.stIPC_m.film = MDIN_DEINT_FILM_OFF;
 260   1        stVideo.stIPC_m.gain = 34;
 261   1        stVideo.stIPC_m.fine = MDIN_DEINT_3DNR_ON | MDIN_DEINT_CCS_ON;
 262   1      
 263   1        // define map of frame buffer
 264   1        stVideo.stMAP_m.frmt = MDIN_MAP_AUX_OFF_NR_ON;  // when MDIN_DEINT_3DNR_ON
 265   1      //  stVideo.stMAP_m.frmt = MDIN_MAP_AUX_OFF_NR_OFF; // when MDIN_DEINT_3DNR_OFF
 266   1      
 267   1        // define video format of PORTB-INPUT
 268   1        stVideo.stSRC_b.frmt = VIDSRC_1280x720p50;
 269   1        stVideo.stSRC_b.mode = MDIN_SRC_MUX656_8;
 270   1        stVideo.stSRC_b.fine = MDIN_FIELDID_INPUT | MDIN_LOW_IS_TOPFLD;
 271   1      
 272   1        // define video format of AUX-OUTPUT
 273   1        stVideo.stOUT_x.frmt = VIDOUT_1280x720p50;
 274   1        stVideo.stOUT_x.mode = MDIN_OUT_RGB444_8;
 275   1        stVideo.stOUT_x.fine = MDIN_SYNC_FREERUN; // set aux outsync free-run
 276   1      
 277   1        stVideo.stOUT_x.brightness = 128;     // set aux picture factor
 278   1        stVideo.stOUT_x.contrast = 128;
 279   1        stVideo.stOUT_x.saturation = 128;
 280   1        stVideo.stOUT_x.hue = 128;
 281   1      
 282   1      #if RGB_GAIN_OFFSET_TUNE == 1
                stVideo.stOUT_x.r_gain = 128;       // set aux gain/offset
                stVideo.stOUT_x.g_gain = 128;
                stVideo.stOUT_x.b_gain = 128;
                stVideo.stOUT_x.r_offset = 128;
                stVideo.stOUT_x.g_offset = 128;
                stVideo.stOUT_x.b_offset = 128;
              #endif
 290   1      
 291   1        // define video format of HDMI-OUTPUT
 292   1        stVideo.stVID_h.mode  = HDMI_OUT_RGB444_8;
 293   1        stVideo.stVID_h.fine  = HDMI_CLK_EDGE_RISE;
C51 COMPILER V9.60.7.0   APP340                                                            12/22/2023 18:00:43 PAGE 6   

 294   1      
 295   1        stVideo.stAUD_h.frmt  = AUDIO_INPUT_I2S_0;            // audio input format
 296   1        stVideo.stAUD_h.freq  = AUDIO_MCLK_256Fs | AUDIO_FREQ_48kHz;  // sampling frequency
 297   1        stVideo.stAUD_h.fine  = AUDIO_MAX24B_MINUS0 | AUDIO_SD_JUST_LEFT | AUDIO_WS_POLAR_HIGH |
 298   1                    AUDIO_SCK_EDGE_RISE | AUDIO_SD_MSB_FIRST | AUDIO_SD_1ST_SHIFT;
 299   1        MDINHTX_SetHDMIBlock(&stVideo);   // initialize HDMI block
 300   1      
 301   1        // define window for inter-area
 302   1        stInterWND.lx = 315;  stInterWND.rx = 405;
 303   1        stInterWND.ly = 90;   stInterWND.ry = 150;
 304   1        MDIN3xx_SetDeintInterWND(&stInterWND, MDIN_INTER_BLOCK0);
 305   1        MDIN3xx_EnableDeintInterWND(MDIN_INTER_BLOCK0, OFF);
 306   1      
 307   1        stVideo.exeFLAG = MDIN_UPDATE_MAINFMT;  // execution of video process
 308   1      
 309   1        //if(MDIN_debug) 
 310   1        MDIN3xx_SetSrcTestPattern(&stVideo, MDIN_IN_TEST_H_RAMP);
 311   1        MDIN3xx_SetSrcTestPattern(&stVideo, MDIN_IN_TEST_DISABLE);
 312   1        //if(MDIN_debug) 
 313   1        //MDIN3xx_SetOutTestPattern(MDIN_OUT_TEST_COLOR);
 314   1      }
 315          
 316          //--------------------------------------------------------------------------------------------------------
             -------------------
 317          
 318          void MDIN340(void)
 319          {
 320   1          
 321   1          if (stVideo.exeFLAG) {          // check change video formats
 322   2            MDIN3xx_EnableMainDisplay(OFF);
 323   2            MDIN3xx_VideoProcess(&stVideo);   // mdin3xx main video process
 324   2            MDIN3xx_EnableMainDisplay(ON);
 325   2            //MDINHTX_CtrlHandler(&stVideo);      // hdmi-tx control handler
 326   2          }
 327   1          MDINHTX_CtrlHandler(&stVideo);      // hdmi-tx control handler
 328   1      }
 329          
 330          /*  FILE_END_HERE */


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    704    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    362       2
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
