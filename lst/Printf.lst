C51 COMPILER V9.60.7.0   PRINTF                                                            12/22/2023 18:00:40 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE PRINTF
OBJECT MODULE PLACED IN .\obj\Printf.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE src\Printf.c LARGE OPTIMIZE(9,SIZE) BROWSE DEBUG OBJECTEXTEND PRINT(.\ls
                    -t\Printf.lst) TABS(2) OBJECT(.\obj\Printf.obj)

line level    source

   1          // *****************************************************
   2          // Company : Techpoint Inc
   3          // $Id: Printf.c 16054 2013-10-17 21:05:52Z SJ $
   4          // $Author: SJ $
   5          // $Date: 2013-10-17 14:05:52 -0700 (Thu, 17 Oct 2013) $
   6          // $Revision: 00 $
   7          // $Log:  $
   8          // ******************************************************
   9          #include "inc\Config.h"
  10          
  11          #include "inc\reg.h"
  12          #include "inc\Typedefs.h"
  13          //#include "debug.h"
  14          #include "inc\main.h"
  15          #include "inc\printf.h"
  16          #include <stdarg.h>
  17          
  18          CODE BYTE Hex[] = "0123456789ABCDEF";
  19          extern  bit       RS_Xbusy;     // bit RS_Xbusy=0;
  20          extern  IDATA BYTE  DebugLevel;
  21          
  22          
  23          void DoPrint( const char CODE_P *fmt, va_list ap )
  24          {
  25   1        char  ch;
  26   1        char  i;
  27   1        long  value;
  28   1        bit   fl_zero;
  29   1        bit   fl_num;
  30   1        bit   fl_long;
  31   1        BYTE  cnt;
  32   1        DWORD mask=1;
  33   1      
  34   1        #ifdef KEILC
  35   1        char *ptr;
  36   1        #endif
  37   1      
  38   1        while(1) {
  39   2          
  40   2          //----- Find Formatter % -----
  41   2      
  42   2          switch( ch = *fmt++ ) {
  43   3            case 0:
  44   3              return;
  45   3            case '%':
  46   3              if( *fmt != '%' )
  47   3                break;
  48   3              fmt++;
  49   3            default:
  50   3              _outchar( ch );
  51   3              continue;
  52   3          }
  53   2      
  54   2          //----- Get Count -------------
C51 COMPILER V9.60.7.0   PRINTF                                                            12/22/2023 18:00:40 PAGE 2   

  55   2          
  56   2          fl_zero = 0;
  57   2          fl_num = 0;
  58   2          cnt = 0;
  59   2      
  60   2          ch = *fmt++;
  61   2      
  62   2          if( ch=='0' ) {
  63   3            fl_zero = 1;
  64   3            ch = *fmt++;
  65   3            cnt = ch - '0';
  66   3            ch = *fmt++;
  67   3          }
  68   2          else if( ch>='0' && ch<='9' ) {
  69   3            cnt = ch - '0';
  70   3            ch = *fmt++;
  71   3          }
  72   2      
  73   2          //----- Get long ----------------
  74   2      
  75   2          fl_long = 0;
  76   2          if( ch=='l' || ch=='L' ) {
  77   3            ch = *fmt++;
  78   3            fl_long = 1;
  79   3          }
  80   2          
  81   2          //----- Get Type Discriptor -----
  82   2          
  83   2          switch( ch ) {
  84   3      
  85   3            case 'd':
  86   3            case 'D':
  87   3              if( fl_long ) value = (DWORD)va_arg( ap, DWORD );
  88   3              else          value = (WORD)va_arg( ap, WORD );
  89   3      
  90   3              if(cnt==0) {
  91   4                if( value==0 ) { _outchar('0'); continue; }
  92   4      
  93   4                for(cnt=0, mask=1; cnt<9; cnt++) {
  94   5                  if( (value/mask)==0 ) break;
  95   5                  mask = mask*10;
  96   5                }
  97   4              }
  98   3      
  99   3              for(i=0, mask=1; i<cnt; i++) mask = mask*10;
 100   3      
 101   3              while(1) {
 102   4                value = value % (mask);
 103   4                mask = mask / 10;
 104   4                ch = (value / mask) + '0';
 105   4                
 106   4                if( ch=='0' && fl_zero==0 && mask!=1 ) ch=' ';
 107   4                else fl_zero = 1;
 108   4                
 109   4                _outchar(ch);
 110   4                if( mask==1 ) 
 111   4                  break;
 112   4              }
 113   3              continue;
 114   3      
 115   3            case 'x':
 116   3            case 'X':
C51 COMPILER V9.60.7.0   PRINTF                                                            12/22/2023 18:00:40 PAGE 3   

 117   3      
 118   3              if( fl_long ) value = (DWORD)va_arg( ap, DWORD );
 119   3              else          value = (WORD)va_arg( ap, WORD );
 120   3      
 121   3      
 122   3              if(cnt==0) cnt = 4;
 123   3              for(i=0; i<cnt; i++) {
 124   4                _outchar( Hex[(value >> (cnt-i-1)*4) & 0x000f] );
 125   4              }
 126   3              continue;
 127   3      
 128   3            case 's':
 129   3      
 130   3              #ifdef TASKINGC
                      
                      value = (WORD)va_arg( ap, WORD );
                      while(*(char CODE_P *)value!='\0')
                        _outchar(*(char CODE_P *)value++);
                      continue;
              
                      #elif defined KEILC
 138   3              
 139   3              ptr = (char *)va_arg( ap, char* );
 140   3              while(*ptr!='\0')
 141   3                _outchar(*ptr++);
 142   3              continue;
 143   3      
 144   3              #endif
 145   3      
 146   3      
 147   3            case 'c':
 148   3              value = va_arg( ap, int );
 149   3                _outchar((BYTE)value);
 150   3              continue;
 151   3      
 152   3            default:
 153   3              value = (WORD)va_arg( ap, int );
 154   3              continue;
 155   3          }
 156   2        }
 157   1      }
 158          
 159          //===========================================================================//
 160          //                                                                           //
 161          //===========================================================================//
 162          //va_list ap;
 163          
 164          void Printf( const char CODE_P *fmt, ... )
 165          {
 166   1        va_list ap;
 167   1      
 168   1        va_start(ap, fmt);
 169   1        DoPrint( fmt, ap );
 170   1        va_end( ap );
 171   1      }
 172          
 173          void Puts( CODE_P char *ptr )
 174          {
 175   1        while(*ptr!='\0')
 176   1          RS_tx(*ptr++);
 177   1      }
 178          
C51 COMPILER V9.60.7.0   PRINTF                                                            12/22/2023 18:00:40 PAGE 4   

 179          //===========================================================================//
 180          //                                                                           //
 181          //===========================================================================//
 182          #ifdef DEBUG
              
              void dPrintf( const char CODE_P *fmt, ... )
              {
                va_list ap;
              
                if( DebugLevel >= DEBUG_INFO ) {
                  va_start(ap, fmt);
                  DoPrint( fmt, ap );
                  va_end( ap );
                }
              }
              /*
              void wPrintf( const char rom *fmt, ... )
              {
                va_list ap;
              
                if( DebugLevel >= DEBUG_WARN ) {
                  va_start(ap, fmt);
                  DoPrint( fmt, ap );
                  va_end( ap );
                }
              }
              */
              
              void ePrintf( const char CODE_P *fmt, ... )
              {
                va_list ap;
              
                if( DebugLevel >= DEBUG_ERR ) {
                  va_start(ap, fmt);
                  DoPrint( fmt, ap );
                  va_end( ap );
                }
              }
              
              //===========================================================================//
              //                                                                           //
              //===========================================================================//
              void dPuts( CODE_P char *ptr )
              {
                if( DebugLevel >= DEBUG_INFO ) {
                  while(*ptr!='\0')
                    RS_tx(*ptr++);
                }
              }
              
              void wPuts( CODE_P char *ptr )
              {
                if( DebugLevel >= DEBUG_WARN ) {
                  while(*ptr!='\0')
                    RS_tx(*ptr++);
                }
              }
              
              void ePuts( CODE_P char *ptr )
              {
                if( DebugLevel >= DEBUG_ERR ) {
                  while(*ptr!='\0')
C51 COMPILER V9.60.7.0   PRINTF                                                            12/22/2023 18:00:40 PAGE 5   

                    RS_tx(*ptr++);
                }
              }
              
              #endif // DEBUG
 246          
 247          //===========================================================================//
 248          //                                                                           //
 249          //===========================================================================//
 250          /*
 251          #ifdef DEBUG
 252          BYTE Getch(void)
 253          {
 254            while(!RS_ready());
 255            return RS_rx();
 256          }
 257          #endif
 258          
 259          BYTE Getche(void)
 260          {
 261            BYTE ch;
 262          
 263            while(!RS_ready());
 264            ch = RS_rx();
 265            RS_tx(ch);
 266          
 267            return ch;
 268          }
 269          */


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    795    ----
   CONSTANT SIZE    =     17    ----
   XDATA SIZE       =   ----      69
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       3
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
